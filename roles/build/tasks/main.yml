---
- name: Ensure facts gathered
  ansible.builtin.include_tasks: gather-facts.yml

- name: Ensure preflight check
  ansible.builtin.include_role:
    name: "{{ preflight_item.name }}"
    public: true
    tasks_from: preflight
  when: preflight_item.preflight and preflight_item.enabled
  loop_control:
    loop_var: preflight_item
  loop: "{{ roles }}"

- name: Ensure workstation build
  ansible.builtin.include_role:
    name: "{{ build_item }}"
    public: true
  loop_control:
    loop_var: build_item
  loop: "{{ roles }}"
  when: build_item.enabled

- name: Ensure workstation post-build
  ansible.builtin.include_role:
    name: "{{ post.name }}"
    public: true
    tasks_from: post-build.yml
  when: "'post_build' in post and post.post_build and post.enabled"
  loop_control:
    loop_var: post
  loop: "{{ roles }}"
